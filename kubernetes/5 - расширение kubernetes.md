## Мотивация

Шаблон оператора призван отразить ключевую цель человека-оператора, управляющего сервисом или набором сервисов. Люди-операторы, которые заботятся о конкретных приложениях и сервисах, обладают глубокими знаниями о том, как должна вести себя система, как ее развернуть и как реагировать в случае возникновения проблем.

Люди, запускающие рабочие нагрузки на Kubernetes, часто предпочитают использовать автоматизацию для выполнения повторяющихся задач. Шаблон оператора описывает, как можно написать код для автоматизации задачи, выходящей за рамки того, что предоставляет сам Kubernetes.

## Операторы в kubernetes

Kubernetes создан для автоматизации. Из коробки вы получаете множество встроенных средств автоматизации в ядре Kubernetes. Вы можете использовать Kubernetes для автоматизации развертывания и запуска рабочих нагрузок, и вы можете автоматизировать то, как Kubernetes это делает.
Концепция паттерна оператора Kubernetes позволяет расширить поведение кластера без изменения кода самого Kubernetes, связав контроллеры с одним или несколькими пользовательскими ресурсами. Операторы - это клиенты Kubernetes API, которые действуют как контроллеры для пользовательского ресурса.

## Пример оператора
Некоторые из вещей, которые можно автоматизировать с помощью оператора, включают:

- развертывание приложения по требованию
- создание и восстановление резервных копий состояния приложения
- обработка обновлений кода приложения наряду с сопутствующими изменениями, такими как схемы баз данных или дополнительные параметры конфигурации
- публикация службы для приложений, которые не поддерживают API Kubernetes, чтобы обнаружить их
- имитация отказа всего кластера или его части для проверки его устойчивости
- выбор лидера для распределенного приложения без внутреннего процесса выборов участников

Как может выглядеть оператор более подробно? Вот пример:

- Пользовательский ресурс SampleDB, который можно сконфигурировать в кластере.
- Развертывание, которое обеспечивает запуск Pod, содержащего контроллерную часть оператора.
- Образ контейнера с кодом оператора.
- Код контроллера, который запрашивает плоскость управления, чтобы узнать, какие ресурсы SampleDB настроены.
- Ядро оператора - это код, который сообщает серверу API, как обеспечить соответствие реальности сконфигурированным ресурсам.
	- Если вы добавляете новый SampleDB, оператор устанавливает PersistentVolumeClaims для обеспечения долговременного хранения базы данных, StatefulSet для запуска SampleDB и Job для обработки начальной конфигурации.
	- Если вы удаляете его, оператор делает снимок, затем убеждается, что StatefulSet и тома также удалены.
- Оператор также управляет регулярным резервным копированием базы данных. Для каждого ресурса SampleDB оператор определяет, когда создать Pod, который может подключаться к базе данных и создавать резервные копии. Эти капсулы будут опираться на ConfigMap и/или Secret, содержащие данные подключения к базе данных и учетные данные.
- Поскольку оператор стремится обеспечить надежную автоматизацию ресурса, которым он управляет, потребуется дополнительный вспомогательный код. В данном примере код проверяет, работает ли база данных со старой версией, и, если да, создает объекты Job, которые обновляют ее для вас.

## Развертывание операторов

Наиболее распространенным способом развертывания оператора является добавление пользовательского определения ресурса и связанного с ним контроллера в кластер. Контроллер обычно запускается вне плоскости управления, так же, как и любое контейнерное приложение. Например, вы можете запустить контроллер в своем кластере как развертывание.

